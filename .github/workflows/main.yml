name: Build Flutter APK

on:
  push:
    branches:
      - main
  workflow_dispatch:  # âœ… Manual trigger Ø¨Ú¾ÛŒ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.5'
          channel: 'stable'

      # âœ… Ø¨ÛØªØ± backup Ø§ÙˆØ± recreation
      - name: Prepare Flutter Project
        run: |
          echo "ğŸ”„ Preparing Flutter project..."
          
          # Important files backup
          mkdir -p /tmp/backup
          cp -r lib/ /tmp/backup/ || true
          cp -r assets/ /tmp/backup/ || true
          cp pubspec.yaml /tmp/backup/ || true
          cp -r android/app/src/main/res/ /tmp/backup/android_res/ || true || true
          cp -r ios/Runner/Assets.xcassets/ /tmp/backup/ios_assets/ || true
          
          # Platform folders ØµØ§Ù Ú©Ø±ÛŒÚº
          rm -rf android ios linux macos windows
          
          # âœ… Ù†ÛŒØ§ Flutter project Ø¨Ù†Ø§Ø¦ÛŒÚº
          flutter create --project-name aladdin_app --org com.aladdin .
          
          # âœ… Backup restore Ú©Ø±ÛŒÚº
          echo "ğŸ“¦ Restoring custom files..."
          rm -f pubspec.yaml pubspec.lock  # Ù¾Ø±Ø§Ù†Û’ files ÛÙ¹Ø§Ø¦ÛŒÚº
          cp /tmp/backup/pubspec.yaml . 
          cp -r /tmp/backup/lib/* lib/ || true
          
          # âœ… Assets Ø§ÙˆØ± icons restore
          mkdir -p assets/
          cp -r /tmp/backup/assets/* assets/ || true
          
          if [ -d "/tmp/backup/android_res" ]; then
            mkdir -p android/app/src/main/res/
            cp -r /tmp/backup/android_res/* android/app/src/main/res/ || true
          fi
          
          if [ -d "/tmp/backup/ios_assets" ]; then
            mkdir -p ios/Runner/Assets.xcassets/
            cp -r /tmp/backup/ios_assets/* ios/Runner/Assets.xcassets/ || true
          fi
          
          echo "âœ… Project preparation completed!"

      # âœ… Pub cache Ù…Ú©Ù…Ù„ ØµØ§Ù Ú©Ø±ÛŒÚº
      - name: Clean Everything
        run: |
          flutter clean
          flutter pub cache clean
          rm -f pubspec.lock
          echo "âœ… Clean completed!"

      # âœ… Dependencies install
      - name: Get Dependencies
        run: flutter pub get

      # âœ… Dependencies verify
      - name: Verify Dependencies
        run: |
          echo "ğŸ“‹ Checking font_awesome_flutter version:"
          flutter pub deps | grep font_awesome_flutter || echo "Not found"
          flutter doctor -v

      # âœ… Build APK
      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons

      # âœ… APK upload
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: aladdin-app-release-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # âœ… Success message
      - name: Build Success
        run: |
          echo "ğŸ‰ Build COMPLETED SUCCESSFULLY!"
          echo "ğŸ“± APK: build/app/outputs/flutter-apk/app-release.apk"
          ls -la build/app/outputs/flutter-apk/
