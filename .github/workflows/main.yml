name: Android Permission Check & Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  permission-check:
    name: ğŸ” Android Permission & Build Log
    runs-on: ubuntu-latest

    permissions:
      contents: read
      metadata: read
      packages: read

    steps:
      # âœ… Step 1: Checkout Repository
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      # âœ… Step 2: Setup Java (Fixed)
      - name: â˜• Setup Java Environment
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'   # âœ… FIXED missing key
          java-version: '17'        # âœ… Compatible JDK for Flutter/Gradle

      # âœ… Step 3: Setup Flutter
      - name: ğŸ¦ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'

      # âœ… Step 4: Get Flutter Dependencies
      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      # âœ… Step 5: Analyze Android Permissions
      - name: ğŸ§  Analyze Android Permissions
        run: |
          echo "ğŸ” Checking Android permissions..."
          mkdir -p build
          grep "<uses-permission" android/app/src/main/AndroidManifest.xml > build/build.log || echo "âš ï¸ No permissions found in AndroidManifest.xml" > build/build.log
          cat build/build.log

      # âœ… Step 6: Verify Gradle Wrapper (Optional but Safe)
      - name: ğŸ§° Verify Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      # âœ… Step 7: Upload Permission Report (Artifact)
      - name: ğŸ“¤ Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-permission-build-log
          path: build/build.log

      # âœ… Step 8: Optional - Flutter Analyze
      - name: ğŸ§© Flutter Analyze
        run: flutter analyze || true

      # âœ… Step 9: Optional - Build APK
      - name: ğŸ—ï¸ Build APK
        run: flutter build apk --release

      # âœ… Step 10: Upload APK as Artifact
      - name: ğŸ“¦ Upload Built APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: AladdinAI-App-APK
          path: build/app/outputs/flutter-apk/app-release.apk
