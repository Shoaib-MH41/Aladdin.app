name: Build Flutter APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.5'
          channel: 'stable'

      # ✅ صرف ضرورت پڑنے پر ہی project بنائیں
      - name: Check and Fix Flutter Project
        run: |
          # صرف ضروری فائلیں چیک کریں
          if [ ! -f "pubspec.yaml" ]; then
            echo "❌ pubspec.yaml not found - creating new project"
            flutter create --project-name aladdin_app .
          elif [ ! -d "android" ] || [ ! -d "ios" ]; then
            echo "⚠️ Missing platform folders - recreating..."
            
            # Important files کو backup کریں
            if [ -d "android/app/src/main/res" ]; then
              echo "Backing up Android icons..."
              cp -r android/app/src/main/res /tmp/android_res_backup
            fi
            
            if [ -d "ios/Runner/Assets.xcassets" ]; then
              echo "Backing up iOS assets..."
              cp -r ios/Runner/Assets.xcassets /tmp/ios_assets_backup
            fi
            
            # صرف missing platform folders recreate کریں
            flutter create --project-name aladdin_app .
            
            # Icons restore کریں
            if [ -d "/tmp/android_res_backup" ]; then
              echo "Restoring Android icons..."
              cp -r /tmp/android_res_backup/* android/app/src/main/res/ || true
            fi
            
            if [ -d "/tmp/ios_assets_backup" ]; then
              echo "Restoring iOS assets..."
              cp -r /tmp/ios_assets_backup/* ios/Runner/Assets.xcassets/ || true
            fi
          else
            echo "✅ Project structure looks good"
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Clean project
        run: flutter clean

      - name: Build release APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk

      # ✅ اضافی: Build info
      - name: Display Build Info
        run: |
          echo "📱 APK Build Completed Successfully!"
          echo "📦 APK Size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
          echo "🚀 Uploaded as artifact: app-release.apk"
