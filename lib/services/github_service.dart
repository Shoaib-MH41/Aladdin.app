import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class GitHubService {
  static const String _tokenKey = 'github_token';
  final FlutterSecureStorage _secureStorage = const FlutterSecureStorage();

  /// ğŸ”¹ GitHub Token Ø­Ø§ØµÙ„ Ú©Ø±ÛŒÚº
  Future<String?> getSavedToken() async {
    try {
      String? token = await _secureStorage.read(key: _tokenKey);
      if (token != null && token.isNotEmpty) {
        print('âœ… GitHub token found');
        return token;
      }
      print('âš ï¸ GitHub token not found');
      return null;
    } catch (e) {
      print('âš ï¸ [GitHubService] Token read error: $e');
      return null;
    }
  }

  /// ğŸ”¹ Token Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº
  Future<void> saveToken(String token) async {
    try {
      await _secureStorage.write(key: _tokenKey, value: token.trim());
      print('âœ… GitHub token securely saved');
    } catch (e) {
      throw Exception('Ù¹ÙˆÚ©Ù† Ø³ÛŒÙˆ Ù†Ø§Ú©Ø§Ù…: $e');
    }
  }

  /// ğŸ”¹ Token Ø­Ø°Ù Ú©Ø±ÛŒÚº
  Future<void> removeToken() async {
    try {
      await _secureStorage.delete(key: _tokenKey);
      print('ğŸ—‘ï¸ GitHub token removed');
    } catch (e) {
      throw Exception('Ù¹ÙˆÚ©Ù† ÚˆÛŒÙ„ÛŒÙ¹ Ù†Ø§Ú©Ø§Ù…: $e');
    }
  }

  /// ğŸ”¹ GitHub Ú©Ù†Ú©Ø´Ù† Ú†ÛŒÚ© Ú©Ø±ÛŒÚº
  Future<bool> checkConnection() async {
    try {
      final token = await getSavedToken();
      if (token == null) return false;

      final response = await http.get(
        Uri.parse('https://api.github.com/user'),
        headers: {
          'Authorization': 'token $token',
          'Accept': 'application/vnd.github.v3+json',
        },
      );

      if (response.statusCode == 200) {
        print('âœ… GitHub connection successful');
        return true;
      } else {
        print('âŒ GitHub connection failed: ${response.statusCode}');
        return false;
      }
    } catch (e) {
      print('âš ï¸ GitHub connection error: $e');
      return false;
    }
  }

  /// ğŸ”¹ ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø­Ø§ØµÙ„ Ú©Ø±ÛŒÚº
  Future<String> _getUsername(String token) async {
    try {
      final response = await http.get(
        Uri.parse('https://api.github.com/user'),
        headers: {
          'Authorization': 'token $token',
          'Accept': 'application/vnd.github.v3+json',
        },
      );

      if (response.statusCode == 200) {
        final userData = jsonDecode(response.body);
        final username = userData['login'];
        print('âœ… GitHub username: $username');
        return username;
      } else {
        throw Exception('ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø­Ø§ØµÙ„ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒ: ${response.statusCode}');
      }
    } catch (e) {
      throw Exception('ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø­Ø§ØµÙ„ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: $e');
    }
  }

  /// ğŸ”¹ Repository Ù†Ø§Ù… Ø¯Ø±Ø³Øª Ú©Ø±ÛŒÚº
  String _sanitizeRepoName(String repoName) {
    // ØµØ±Ù allowed characters Ø±Ú©Ú¾ÛŒÚº
    String sanitized = repoName.replaceAll(RegExp(r'[^a-zA-Z0-9._-]'), '-');
    // 100 characters Ø³Û’ Ø²ÛŒØ§Ø¯Û Ù†Û ÛÙˆ
    if (sanitized.length > 100) {
      sanitized = sanitized.substring(0, 100);
    }
    // lowercase Ù…ÛŒÚº ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº
    return sanitized.toLowerCase();
  }

  /// ğŸ”¹ Ù†ÛŒØ§ Repository Ø¨Ù†Ø§Ø¦ÛŒÚº
  Future<String> createRepository(
    String repoName, {
    String description = 'Auto-generated by Aladdin AI App Factory ğŸš€',
    bool private = false,
  }) async {
    final token = await getSavedToken();
    if (token == null || token.isEmpty) {
      throw Exception('âš ï¸ GitHub token Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û” Settings Ù…ÛŒÚº Ù¹ÙˆÚ©Ù† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚºÛ”');
    }

    try {
      final sanitizedRepoName = _sanitizeRepoName(repoName);
      
      final response = await http.post(
        Uri.parse('https://api.github.com/user/repos'),
        headers: {
          'Authorization': 'token $token',
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: jsonEncode({
          'name': sanitizedRepoName,
          'description': description,
          'private': private,
          'auto_init': true, // README.md Ø®ÙˆØ¯ Ø¨Ø®ÙˆØ¯ Ø¨Ù† Ø¬Ø§Ø¦Û’ Ú¯ÛŒ
          'has_issues': true,
          'has_projects': false,
          'has_wiki': false,
        }),
      );

      if (response.statusCode == 201) {
        final repoData = jsonDecode(response.body);
        final repoUrl = repoData['html_url'];
        print('âœ… Repository created: $repoUrl');
        return repoUrl;
      } else if (response.statusCode == 422) {
        // Repository Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’
        final username = await _getUsername(token);
        final repoUrl = 'https://github.com/$username/$sanitizedRepoName';
        print('âš ï¸ Repository already exists: $repoUrl');
        return repoUrl;
      } else {
        final errorBody = jsonDecode(response.body);
        final errorMessage = errorBody['message'] ?? 'Unknown error';
        throw Exception('GitHub Ø®Ø±Ø§Ø¨ÛŒ (${response.statusCode}): $errorMessage');
      }
    } catch (e) {
      throw Exception('GitHub Ú©Ù†Ú©Ø´Ù† Ù†Ø§Ú©Ø§Ù…: $e');
    }
  }

  /// ğŸ”¹ ÙØ§Ø¦Ù„ Ø§Ù¾Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº
  Future<void> uploadFile({
    required String repoName,
    required String filePath,
    required String content,
    String branch = 'main',
    String commitMessage = 'Auto-commit by Aladdin AI',
  }) async {
    final token = await getSavedToken();
    if (token == null || token.isEmpty) {
      throw Exception('âš ï¸ GitHub token Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û” Settings Ù…ÛŒÚº Ù¹ÙˆÚ©Ù† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚºÛ”');
    }

    try {
      final username = await _getUsername(token);
      final sanitizedRepoName = _sanitizeRepoName(repoName);
      final encodedContent = base64Encode(utf8.encode(content));

      final response = await http.put(
        Uri.parse('https://api.github.com/repos/$username/$sanitizedRepoName/contents/$filePath'),
        headers: {
          'Authorization': 'token $token',
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: jsonEncode({
          'message': commitMessage,
          'content': encodedContent,
          'branch': branch,
          'committer': {
            'name': 'Aladdin AI App Factory',
            'email': 'hello@aladdin.app'
          }
        }),
      );

      if (response.statusCode == 201 || response.statusCode == 200) {
        print('âœ… File uploaded successfully: $filePath');
      } else {
        final errorBody = jsonDecode(response.body);
        final errorMessage = errorBody['message'] ?? 'Upload failed';
        
        if (errorMessage.contains('already exists')) {
          // ÙØ§Ø¦Ù„ Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’ØŒ update Ú©Ø±ÛŒÚº
          await _updateFile(
            token: token,
            username: username,
            repoName: sanitizedRepoName,
            filePath: filePath,
            content: content,
            branch: branch,
            commitMessage: 'Update: $commitMessage',
          );
        } else {
          throw Exception('ÙØ§Ø¦Ù„ Ø§Ù¾Ù„ÙˆÚˆ Ù†Ø§Ú©Ø§Ù…: $errorMessage');
        }
      }
    } catch (e) {
      throw Exception('ÙØ§Ø¦Ù„ Ø§Ù¾Ù„ÙˆÚˆ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: $e');
    }
  }

  /// ğŸ”¹ Ù…ÙˆØ¬ÙˆØ¯Û ÙØ§Ø¦Ù„ Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº
  Future<void> _updateFile({
    required String token,
    required String username,
    required String repoName,
    required String filePath,
    required String content,
    required String branch,
    required String commitMessage,
  }) async {
    try {
      // Ù¾ÛÙ„Û’ Ù…ÙˆØ¬ÙˆØ¯Û ÙØ§Ø¦Ù„ Ú©Ø§ SHA Ø­Ø§ØµÙ„ Ú©Ø±ÛŒÚº
      final existingFileResponse = await http.get(
        Uri.parse('https://api.github.com/repos/$username/$repoName/contents/$filePath'),
        headers: {
          'Authorization': 'token $token',
          'Accept': 'application/vnd.github.v3+json',
        },
      );

      String? sha;
      if (existingFileResponse.statusCode == 200) {
        final existingFileData = jsonDecode(existingFileResponse.body);
        sha = existingFileData['sha'];
      }

      final encodedContent = base64Encode(utf8.encode(content));

      final response = await http.put(
        Uri.parse('https://api.github.com/repos/$username/$repoName/contents/$filePath'),
        headers: {
          'Authorization': 'token $token',
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: jsonEncode({
          'message': commitMessage,
          'content': encodedContent,
          'branch': branch,
          'sha': sha, // Ù…ÙˆØ¬ÙˆØ¯Û ÙØ§Ø¦Ù„ Ú©Ùˆ Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ SHA Ø¶Ø±ÙˆØ±ÛŒ ÛÛ’
          'committer': {
            'name': 'Aladdin AI App Factory',
            'email': 'hello@aladdin.app'
          }
        }),
      );

      if (response.statusCode == 200 || response.statusCode == 201) {
        print('âœ… File updated successfully: $filePath');
      } else {
        throw Exception('ÙØ§Ø¦Ù„ Ø§Ù¾ÚˆÛŒÙ¹ Ù†Ø§Ú©Ø§Ù…: ${response.statusCode}');
      }
    } catch (e) {
      throw Exception('ÙØ§Ø¦Ù„ Ø§Ù¾ÚˆÛŒÙ¹ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: $e');
    }
  }

  /// ğŸ”¹ Ù…Ú©Ù…Ù„ Ù¾Ø±ÙˆØ¬ÛŒÚ©Ù¹ Ø§Ù¾Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº
  Future<void> uploadCompleteProject({
    required String repoName,
    required Map<String, String> files, // filePath -> content
    String branch = 'main',
  }) async {
    final token = await getSavedToken();
    if (token == null) {
      throw Exception('âš ï¸ GitHub token Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û”');
    }

    try {
      final username = await _getUsername(token);
      final sanitizedRepoName = _sanitizeRepoName(repoName);

      // ÛØ± ÙØ§Ø¦Ù„ Ø§Ù¾Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº
      for (final entry in files.entries) {
        final filePath = entry.key;
        final content = entry.value;

        await uploadFile(
          repoName: sanitizedRepoName,
          filePath: filePath,
          content: content,
          branch: branch,
          commitMessage: 'Add $filePath - Aladdin AI Project',
        );

        // ØªÚ¾ÙˆÚ‘Ø§ Ø³Ø§ ÙˆÙ‚ÙÛ Ø¯ÛŒÚº ØªØ§Ú©Û GitHub rate limit Ù†Û ÛÙˆ
        await Future.delayed(const Duration(milliseconds: 500));
      }

      print('âœ… Complete project uploaded with ${files.length} files');
    } catch (e) {
      throw Exception('Ù…Ú©Ù…Ù„ Ù¾Ø±ÙˆØ¬ÛŒÚ©Ù¹ Ø§Ù¾Ù„ÙˆÚˆ Ù†Ø§Ú©Ø§Ù…: $e');
    }
  }

  /// ğŸ”¹ Repository Ú©Ø§ Ù„Ù†Ú© Ø­Ø§ØµÙ„ Ú©Ø±ÛŒÚº
  Future<String> getRepoUrl(String repoName) async {
    try {
      final token = await getSavedToken();
      if (token == null) {
        throw Exception('GitHub token not set');
      }

      final username = await _getUsername(token);
      final sanitizedRepoName = _sanitizeRepoName(repoName);
      
      return 'https://github.com/$username/$sanitizedRepoName';
    } catch (e) {
      throw Exception('Repository Ù„Ù†Ú© Ø­Ø§ØµÙ„ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒ: $e');
    }
  }
}
